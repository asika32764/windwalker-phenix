"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}!function(t){var e=function(t,e,n){},n=function(){function n(e,i,o){_classCallCheck(this,n),this.$xhr=null,this.element=e,this.options=t.extend(!0,{},this.constructor.defaultOptions,o),this.dependent=t(i),this.bindEvents(),this.options.initial_load&&this.changeList(this.dependent.val(),!0)}return _createClass(n,null,[{key:"pluginName",get:function(){return"listDependent"}},{key:"defaultOptions",get:function(){return{ajax:{url:null,value_field:"value"},source:null,text_field:"title",value_field:"id",first_option:null,default_value:null,initial_load:!0,empty_mark:"__EMPTY__",hooks:{before_request:e,after_request:e}}}}]),_createClass(n,[{key:"bindEvents",value:function(){var e=this;this.dependent.on("change",function(n){e.changeList(t(n.currentTarget).val())})}},{key:"changeList",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;""===(t=t||this.dependent.val())&&(t=this.options.empty_mark),this.options.ajax.url?this.ajaxUpdate(t):this.options.source&&this.sourceUpdate(t,e)}},{key:"sourceUpdate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.options.source;this.beforeHook(t,this.element,this.dependent),n[t]?this.updateListElements(n[t]):(this.updateListElements([]),e||""===t||0===parseInt(t)||console.log("List for value: "+t+" not found.")),this.afterHook(t,this.element,this.dependent)}},{key:"ajaxUpdate",value:function(t){var e=this,n={};n[this.options.ajax.value_field]=t,this.beforeHook(t,this.element,this.dependent),this.$xhr&&(this.$xhr.abort(),this.$xhr=null),this.$xhr=Phoenix.Ajax.get(this.options.ajax.url,n).done(function(t){t.success?e.updateListElements(t.data):console.error(t.message)}).fail(function(t){console.error(t)}).always(function(){e.afterHook(t,e.element,e.dependent),e.$xhr=null})}},{key:"updateListElements",value:function(e){var n=this,i=this.options.text_field,o=this.options.value_field;this.element.empty(),this.options.first_option&&(e.unshift({}),e[0][i]=this.options.first_option[i],e[0][o]=this.options.first_option[o]),t.each(e,function(e,s){if(Array.isArray(s)){var a=t('<optgroup label="'.concat(e,'"></optgroup>'));return t.each(s,function(t,e){n.appendOptionTo({value:e[o],text:e[i],attributes:e.attributes},a)}),void n.element.append(a)}n.appendOptionTo({value:s[o],text:s[i],attributes:s.attributes},n.element)}),this.element.trigger("chosen:updated"),this.element.trigger("change")}},{key:"appendOptionTo",value:function(e,n){var i=e.value,o=t("<option>"+e.text+"</option>");o.attr("value",i),e.attributes&&t.each(e.attributes,function(t,e){o.attr(t,e)}),this.isSelected(i)&&o.attr("selected","selected"),n.append(o)}},{key:"isSelected",value:function(t){return-1!==(Array.isArray(this.options.default_value)?this.options.default_value:this.options.default_value&&"object"===_typeof(this.options.default_value)?Object.keys(this.options.default_value):[this.options.default_value]).indexOf(t)}},{key:"beforeHook",value:function(t,e,n){return this.options.hooks.before_request.call(this,t,e,n)}},{key:"afterHook",value:function(t,e,n){return this.options.hooks.after_request.call(this,t,e,n)}}]),n}();t.fn[n.pluginName]=function(t,e){return this.data("phoenix."+n.pluginName)||this.data("phoenix."+n.pluginName,new n(this,t,e)),this.data("phoenix."+n.pluginName)}}(jQuery);